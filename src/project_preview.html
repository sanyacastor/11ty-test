---
layout: base.njk
tags: preview
permalink: '/preview/{{ preview.title | slug }}/'
templateEngineOverride: md, njk
eleventyComputed:
  title: {{ preview.title }}
  slug: {{ preview.title | slug }}
pagination:
  data: projectWithImages
  alias: preview
  size: 1
  addAllPagesToCollection: true
---

{% set project = {
  data: {
      title: preview.title,
      dates: preview.dates,
      collaborators: preview.collaborators,
      cardDescription: preview.cardDescription
  }
} %} <!--!!!Peligro!!! Deleteme-->

<link rel="stylesheet" href="bundle.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<article>
  <div class='container'>
    <div class="projectPreview_Grid">
      <card>
        {% include 'summary-card.njk' %}
      </card>
      <pictures>
        <div class="swiper mySwiper">
          <div class="swiper-wrapper" id="preview_swiperWrapper">
            {% for image in preview.images %}
              <div class="swiper-slide">
                <img src='{{ image.url }}' alt='{{ image.alt }}' style='width: 100%; display: block; object-fit: cover; margin: auto;'></img> <!--style='object-fit: cover;'-->
              </div>
            {% endfor %}
          </div>
          <div class="swiper-button-next"></div>
          <div class="swiper-button-prev"></div>
          <div class="swiper-pagination"></div>
        </div>
      </pictures>
      <!--imgcaption>asd</imgcaption-->
      <navigationpanel>
        <div class="navigation_buttons_group">
          <button class="navigation-button left-button"  id="preview_descriptionNavButton_left" >Left</button>
          <button class="navigation-button right-button" id="preview_descriptionNavButton_right">Right</button>
          <button class="navigation-button close-button" id="preview_descriptionNavButton_close" >Close</button>
        </div>
      </navigationpanel>
      <main>
        <div class = "projectPreview_mainTextContainer">
          <div class="projectPreview_textContainer">
            <div id="projectPreview_outer">
              <div class="projectPreview_ScrollArticle" id= "preview_scrollableContent">
                {{preview.previewDescription}}
              </div>
              <div class="projectPreview_phantomColumn" id = "phantomColumn">
                <div class="projectPreview_phantomTrigger"  id = "phantomTrigger"></div>
              </div>
            </div>
          </div>

          <div class="projectPreview_buttonFullProject_container" id="preview_buttonFullProject" >
            <a href={{ "/projects/project_" ~ preview.title | slug }}>
              Full project
            </a>
            <div class="projectPreview_buttonFullProject_arrowRight" id="preview_buttonFullProject_arrow"></div>  
          </div>
        </div>
      </main>  
    </div>
  </div>
</article>


<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", (event) => { /* gsap code */});
</script>

<!-- -------Image swiper with swiperjs------- -->
<script>
  class projectPreviewImgSwiper{
    constructor(classname_swiper, id_swiperWrapper){
      this.swiper =new Swiper(".mySwiper", {
                    slidesPerView: 2,
                    speed: 1000,
                    
                    autoplay: {
                      delay: 2000,
                      pauseOnMouseEnter: true,
                    },
                    pagination: {
                      el: ".swiper-pagination",
                      type: "progressbar",
                    },
                    navigation: {
                      nextEl: ".swiper-button-next",
                      prevEl: ".swiper-button-prev",
                    },
                  });
      
      this.swiperElement = document.getElementsByClassName(classname_swiper)[0];
      this.swiperWrapper = document.getElementById(id_swiperWrapper);
    }
    destructor(){
    }
    onLoad(){
      this.recalc();
    }
    recalc(){
      this.recalcSwiperImages();
    }

    slideNext(){
      this.swiper.slideNext();
    }
    slidePrev(){
      this.swiper.slidePrev();
    }

    recalcSwiperImages(){
      let boxWidth = this.swiperElement.offsetWidth;	

      if(boxWidth > 826){
        this.swiper.params.slidesPerView = 2;
        this.swiperWrapper.style.width = '826px';
      }
      else{
        this.swiper.params.slidesPerView = 1;
        this.swiperWrapper.style.width = '416px';
      }
    }
  }
</script>
<!-- ---------------/Swiper------------------ -->

<!-- -------Description scroller and "full button" unfolder------- -->
<script>
  class projectPreviewScroll{
    constructor(id_outerBox, id_contentBox, id_phantomColumn, id_fullButton, id_fullButtonArrow, gsapTwiner){
      this.gsap = gsapTwiner;

      this.checkpoints = [];
      this.currentChecpointIndex = 0;

      this.buttonIsFolded = true;
      this.buttonCanBeUnfolded = false;
      
      this.projectPreview_buttonFullProject_width = 228;
      this.projectPreview_buttonFullProject_padding = 22;

      this.outerBox = document.getElementById(id_outerBox);
      this.contentBox = document.getElementById(id_contentBox);
      this.phantomColumn = document.getElementById(id_phantomColumn);
      this.fullButton = document.getElementById(id_fullButton);
      this.fullButtonArrow = document.getElementById(id_fullButtonArrow);
    }
    destructor(){     
    }

    onload() {
      this.recalcUnfoldTriggerPosition();
      this.recalcCheckpoints();
      this.moveToCheckpoint(0);
      this.updateButtonFoldState();
    }
    
    onResize() {
      this.recalcUnfoldTriggerPosition();
      this.recalcCheckpoints();
      this.updateButtonFoldState();
    }

    recalcUnfoldTriggerPosition(){
      let scrollLength = this.outerBox.scrollWidth;
      let boxWidth = this.outerBox.offsetWidth;

      let columnWidth = this.contentBox.offsetWidth;
      let numberOfColumns = Math.floor( (scrollLength) / (columnWidth)); //!!!PELIGRO!!!! magic number

      let additionalSectionWidth = boxWidth - columnWidth;
      if(additionalSectionWidth < 0)
        additionalSectionWidth = 0;

      this.phantomColumn.style.width = additionalSectionWidth + "px";
      this.phantomColumn.style.display = "block";
      
      if(additionalSectionWidth > this.projectPreview_buttonFullProject_width + 50){ //!!!! Magic number
        this.buttonCanBeUnfolded = true;
      }
      else{
        this.buttonCanBeUnfolded = false;
      }
    }

    updateButtonFoldState(){
      if( !this.buttonCanBeUnfolded || !this.checkpointIsTheLast())
      {
        this.foldFullProjectButton();
      } else
      {
        this.unfoldFullProjectButton();
      }
    }
    unfoldFullProjectButton(){
      if(!this.buttonIsFolded){
          return;
        }

      this.buttonIsFolded = false;
      let buttonFullProject_arrow = document.getElementById("preview_buttonFullProject_arrow");
      
      this.fullButton.style.height = "288px"; //!!!! Magic number
      this.fullButton.style.bottom = "90px";  //!!!! Magic number
      /*buttonFullProject.style.right = "200px"; */

      this.fullButtonArrow.style["border-top"] = "143px solid transparent";
      this.fullButtonArrow.style["border-bottom"] = "143px solid transparent";
      this.fullButtonArrow.style.animation = "arrow_slideTop 1s ease";
      this.fullButton.style.animation = "slideTop 1s ease"; 
    }
    foldFullProjectButton(){
      if(this.buttonIsFolded){
          return;
        }
        this.buttonIsFolded = true;

        this.fullButton.style.height = "61px"; //!!!! Magic number
        this.fullButton.style.bottom = "8px";  //!!!! Magic number
        
        this.fullButtonArrow.style["border-top"] = "30px solid transparent";
        this.fullButtonArrow.style["border-bottom"] = "30px solid transparent";
        this.fullButtonArrow.style.animation = "arrow_slideBottom 0.5s ease";
        this.fullButton.style.animation = "slideBottom 0.5s ease";
    }

    checkpointIsTheLast(){
      if(this.checkpoints == null || this.checkpoints.length == 0)
        return false;

      return this.currentChecpointIndex == (this.checkpoints.length - 1);
    }
    recalcCheckpoints(){
      this.phantomColumn.style.display = "none";

      let scrollLength = this.outerBox.scrollWidth;
      let boxWidth = this.contentBox.offsetWidth;
      
      let paddingLeft = parseInt(window.getComputedStyle(this.contentBox).paddingLeft);
      let paddingRight = parseInt(window.getComputedStyle(this.contentBox).paddingRight);

      let numberOfSteps = scrollLength / (boxWidth+paddingLeft);

      let fractionalSteps = numberOfSteps % 1;
      if(fractionalSteps > 0.8)  //!!!!Nasty...!!!!
        numberOfSteps = Math.ceil(numberOfSteps);
      else
        numberOfSteps = Math.floor(numberOfSteps);
      
      this.checkpoints = [];
      for(let i = 0; i < numberOfSteps; i++){
        this.checkpoints.push(i * (boxWidth+paddingLeft));
      }

      if(this.checkpoints.length == 1)
        this.checkpoints[0] = 0;

      this.phantomColumn.style.position = "absolute";
      this.phantomColumn.style.left = this.checkpoints[this.checkpoints.length-1] + boxWidth + paddingLeft + "px";
      this.phantomColumn.style.display = "block";
    }

    scrollRight(){
      let targetCheckpointIndex = this.currentChecpointIndex + 1;
      if(targetCheckpointIndex >= this.checkpoints.length){
        targetCheckpointIndex = this.checkpoints.length - 1;
      }

      this.moveToCheckpoint(targetCheckpointIndex);
    }
    scrollLeft(){
      let targetCheckpointIndex = this.currentChecpointIndex - 1;
      if(targetCheckpointIndex < 0){
        targetCheckpointIndex = 0;
      }

      this.moveToCheckpoint(targetCheckpointIndex);
    }

    moveToCheckpoint(index){
      this.currentChecpointIndex = index;

      this.updateButtonFoldState();

      this.gsap.to(  this.outerBox,{
                      scrollLeft: this.checkpoints[index],
                      duration: 0.5, ease: "power2.inOut"
                  });
    }
  }
</script>
<!-- ----------------------/scroller----------------------------- -->

<!--script src="test.js"></script-->

<script>
  var projectPreviewScrollInstance;
  var projectPreviewImgSwiperInstance;
  var gsapTwiner = gsap;
  
  window.addEventListener('load', function() {
    projectPreviewScrollInstance
                 = new projectPreviewScroll('projectPreview_outer',
                                            'preview_scrollableContent',
                                            'phantomColumn',
                                            'preview_buttonFullProject',
                                            'preview_buttonFullProject_arrow',
                                            gsapTwiner);

    projectPreviewImgSwiperInstance
                 = new projectPreviewImgSwiper('mySwiper',
                                               'preview_swiperWrapper');
    assignButtonsEvents();

    projectPreviewScrollInstance.onload();
    projectPreviewImgSwiperInstance.onLoad();
  });

  window.addEventListener('resize', function() {
    projectPreviewScrollInstance.onResize();
    projectPreviewImgSwiperInstance.recalc();

    //testPrint();
  });

  document
    .getElementById('projectPreview_outer')
    .addEventListener('wheel', function (e) {
      // Cross-browser wheel delta
      var delta = e.wheelDelta
        ? e.wheelDelta
        : -e.deltaY;
      
        if(delta>0)
          projectPreviewScrollInstance.scrollLeft();
        else
          projectPreviewScrollInstance.scrollRight();
      //  this.scrollLeft -= (delta);
      e.preventDefault();
    }, false);

  document
    .getElementById('preview_swiperWrapper')
    .addEventListener('wheel', function(e) {
      var delta = e.wheelDelta ? e.wheelDelta : -e.deltaY;

      if(delta > 0){
        projectPreviewImgSwiperInstance.slidePrev();
      } else {
        projectPreviewImgSwiperInstance.slideNext();
      }
    });

  function assignButtonsEvents(){
    document.getElementById('preview_descriptionNavButton_left').addEventListener('click', function() {
      projectPreviewScrollInstance.scrollLeft();
    });

    document.getElementById('preview_descriptionNavButton_right').addEventListener('click', function() {
      projectPreviewScrollInstance.scrollRight();
    });

    document.getElementById('preview_descriptionNavButton_close').addEventListener('click', function() {
      window.location.href = '/';
    });
  }
</script>